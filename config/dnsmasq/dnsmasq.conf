# =============================================================================
# Netboot Server - dnsmasq Configuration
# =============================================================================
# Runs in ProxyDHCP mode: responds to PXE boot requests WITHOUT assigning IPs.
# Your existing DHCP server continues to handle IP assignments.
# =============================================================================

# ---------------------------------------------------------------------------
# General Settings
# ---------------------------------------------------------------------------

# Only listen on the specified interface
interface=eth0

# Do not act as a DNS server
port=0

# Log DHCP/PXE transactions for debugging
log-dhcp

# ---------------------------------------------------------------------------
# ProxyDHCP Mode
# ---------------------------------------------------------------------------

# Enable ProxyDHCP — respond to PXE requests on the existing DHCP subnet
# The IP range here must match your network but dnsmasq will NOT assign IPs
# It only provides the boot filename to PXE clients
dhcp-range=192.168.1.0,proxy

# ---------------------------------------------------------------------------
# TFTP Server
# ---------------------------------------------------------------------------

# Enable the built-in TFTP server
enable-tftp

# Root directory for TFTP files (bootloaders live here)
tftp-root=/srv/tftp

# ---------------------------------------------------------------------------
# PXE Boot Configuration
# ---------------------------------------------------------------------------

# Tag clients by architecture so we serve the right bootloader
# Architecture codes:
#   0  = BIOS (x86)
#   6  = EFI x86 (32-bit)
#   7  = EFI x86_64 (64-bit) — most modern UEFI machines
#   9  = EFI x86_64 (alternate)
#   10 = EFI ARM 32-bit
#   11 = EFI ARM 64-bit

# Detect client architecture from DHCP option 93
dhcp-match=set:bios,option:client-arch,0
dhcp-match=set:efi32,option:client-arch,6
dhcp-match=set:efi64,option:client-arch,7
dhcp-match=set:efi64alt,option:client-arch,9

# Detect iPXE clients — iPXE sets user-class to "iPXE" on its DHCP request
# This MUST come before the dhcp-boot lines so the tag is available
dhcp-userclass=set:ipxe,iPXE

# Serve the appropriate bootloader based on architecture
# tag:!ipxe ensures these only apply to the initial PXE ROM boot, NOT when iPXE re-requests
# BIOS clients get undionly.kpxe (standard iPXE for legacy BIOS)
dhcp-boot=tag:!ipxe,tag:bios,undionly.kpxe

# UEFI clients get ipxe.efi (iPXE for UEFI)
dhcp-boot=tag:!ipxe,tag:efi32,ipxe.efi
dhcp-boot=tag:!ipxe,tag:efi64,ipxe.efi
dhcp-boot=tag:!ipxe,tag:efi64alt,ipxe.efi

# Once iPXE has loaded, chain to our HTTP boot script instead of serving ipxe.efi again
dhcp-boot=tag:ipxe,http://192.168.1.43:8080/ipxe/boot.ipxe

# ---------------------------------------------------------------------------
# PXE Prompt
# ---------------------------------------------------------------------------

# PXE menu prompt — timeout 0 means boot immediately without waiting
pxe-prompt="Netboot Server", 0

# NOTE: pxe-service lines removed — they override dhcp-boot and don't support
# tag filtering, which causes iPXE to receive ipxe.efi again instead of the
# HTTP boot script URL. dhcp-boot with tag:!ipxe handles the chain correctly.
